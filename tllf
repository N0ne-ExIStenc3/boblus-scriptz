local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local Player = Players.LocalPlayer
local Events = ReplicatedStorage:WaitForChild("Events")

local PickupEvent = Events:WaitForChild("Pickup")
local SetTool = Events:WaitForChild("SetTool")

local AUTO_FARM = true
local AUTO_PICKUP = true
local AUTO_MINE = true

local FARM_DELAY = 0.3
local PICKUP_DELAY = 0.25
local PICKUP_DISTANCE = 15
local AUTO_MINE_DELAY = 0.25

local TOOL_NAME = "Lightning Tool"

local AllowedItems = {
	Coin = true,
	Experience = true,
	Egg = true,
	Meat = true,
}

for _, v in ipairs(workspace:GetDescendants()) do
	if v:IsA("ProximityPrompt") then
		v.HoldDuration = 0
	end
end

local function getChar()
	return Player.Character
end

local function getHRP()
	local c = getChar()
	return c and c:FindFirstChild("HumanoidRootPart")
end

local function tp(cf)
	local hrp = getHRP()
	if hrp then
		hrp.CFrame = cf
	end
end

local function equipTool()
	SetTool:FireServer(TOOL_NAME)
end

Player.CharacterAdded:Connect(function()
	task.wait(1.5)
	equipTool()
end)

task.spawn(function()
	while task.wait(5) do
		equipTool()
	end
end)

task.spawn(function()
	while task.wait(AUTO_MINE_DELAY) do
		if AUTO_MINE then
			Events.Mine:FireServer()
		end
	end
end)

local function getItemPosition(item)
	if item:IsA("BasePart") then
		return item.Position
	end
	if item:IsA("Model") then
		local p = item.PrimaryPart or item:FindFirstChildWhichIsA("BasePart", true)
		return p and p.Position
	end
end

local function isNear(item)
	local hrp = getHRP()
	if not hrp then return false end
	local pos = getItemPosition(item)
	if not pos then return false end
	return (hrp.Position - pos).Magnitude <= PICKUP_DISTANCE
end

task.spawn(function()
	while task.wait(PICKUP_DELAY) do
		if not AUTO_PICKUP then continue end
		local folder = workspace:FindFirstChild("Items")
		if not folder then continue end
		for _, item in ipairs(folder:GetChildren()) do
			if AllowedItems[item.Name] and isNear(item) then
				pcall(function()
					PickupEvent:FireServer(item)
				end)
			end
		end
	end
end)

local function getTreePart(tree)
	local part = tree:FindFirstChild("Trunk") or tree:FindFirstChild("Reference")
	if part and part:IsA("BasePart") then
		return part
	end
end

local function findNearestTree()
	local hrp = getHRP()
	if not hrp then return end
	local nearest, dist = nil, math.huge
	for _, tree in ipairs(workspace.Trees:GetChildren()) do
		local part = getTreePart(tree)
		if part then
			local d = (hrp.Position - part.Position).Magnitude
			if d < dist then
				dist = d
				nearest = part
			end
		end
	end
	return nearest
end

local function findRandomTree()
	local parts = {}
	for _, tree in ipairs(workspace.Trees:GetChildren()) do
		local part = getTreePart(tree)
		if part then
			table.insert(parts, part)
		end
	end
	if #parts > 0 then
		return parts[math.random(1, #parts)]
	end
end

local function chopTree(part)
	while part and part.Parent do
		tp(part.CFrame * CFrame.new(0, 0, 3))
		task.wait(0.2)
	end
end

task.spawn(function()
	while task.wait(FARM_DELAY) do
		if not AUTO_FARM then continue end
		local tree = findNearestTree()
		if not tree then
			tree = findRandomTree()
			if tree then
				tp(tree.CFrame + Vector3.new(0, 3, 0))
				task.wait(0.5)
			end
		end
		if tree then
			chopTree(tree)
		end
	end
end)

for _, v in pairs(getconnections(Player.Idled)) do
	v:Disable()
end
