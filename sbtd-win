local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local TeleportService = game:GetService("TeleportService")
local VirtualUser = game:GetService("VirtualUser")

local LP = Players.LocalPlayer

local PLACE_MAIN = 93249115521759
local PLACE_DESERT = 76471028557198

local function queueScript()
    local url = "https://raw.githubusercontent.com/N0ne-ExIStenc3/boblus-scriptz/refs/heads/main/sbtd-win"
    if syn and syn.queue_on_teleport then
        syn.queue_on_teleport('loadstring(game:HttpGet("'..url..'"))()')
    elseif queue_on_teleport then
        queue_on_teleport('loadstring(game:HttpGet("'..url..'"))()')
    end
end
queueScript()

LP.Idled:Connect(function()
    VirtualUser:CaptureController()
    VirtualUser:ClickButton2(Vector2.new())
end)

local function touchFinish()
    local finish = workspace:FindFirstChild("Obby") and workspace.Obby:FindFirstChild("Finish")
    if finish and LP.Character and LP.Character:FindFirstChild("HumanoidRootPart") then
        firetouchinterest(LP.Character.HumanoidRootPart, finish, 0)
        task.wait()
        firetouchinterest(LP.Character.HumanoidRootPart, finish, 1)
    end
end

local function teleport(placeId)
    if game.PlaceId ~= placeId then
        TeleportService:Teleport(placeId, LP)
    end
end

local function getSlaps()
    local ls = LP:FindFirstChild("leaderstats")
    if not ls then return 0 end
    local slaps = ls:FindFirstChild("Slaps")
    return slaps and slaps.Value or 0
end

local function waitForSlaps(amount)
    while getSlaps() < amount do
        RunService.Heartbeat:Wait()
    end
end

local function offsetCF(cf)
    return cf + Vector3.new(
        math.random(-1, 1) * 0.25,
        0,
        math.random(-1, 1) * 0.25
    )
end

local POTATO_CF = CFrame.new(26.44, 157.94, 39.46)
local BULL_CF = CFrame.new(32.81, 158.00, 35.59)

local function farmDesert()
    local Functions = ReplicatedStorage:WaitForChild("Functions")
    local friesTowers = {}

    for i = 1, 3 do
        local potCF = offsetCF(POTATO_CF)
        local potato = Functions.SpawnTower:InvokeServer("Potato", potCF)

        if potato then
            waitForSlaps(1700)

            local fries = Functions.SpawnTower:InvokeServer("Fries", potCF, potato)
            if fries then
                friesTowers[#friesTowers + 1] = fries
            end
        end
    end

    waitForSlaps(27550)

    local function maxOutBull()
        local bullCF = offsetCF(BULL_CF)

        local bull = Functions.SpawnTower:InvokeServer("Bull", bullCF)
        if not bull then return end

        local upgrades = {"Wall", "Brickwall", "Brickedup", "Brickfort"}
        for _, up in ipairs(upgrades) do
            task.wait(0.15)
            local new = Functions.SpawnTower:InvokeServer(up, bullCF, bull)
            if new then
                bull = new
            end
        end

        return bull
    end

    maxOutBull()

    for _, tower in ipairs(friesTowers) do
        pcall(function()
            Functions.SellTower:InvokeServer(tower)
        end)
    end

    while task.wait(0.5) do
        if getSlaps() >= 27550 then
            maxOutBull()
        end
    end
end

local farm = false

task.spawn(function()
    while task.wait(1) do
        local placeId = game.PlaceId

        if placeId == PLACE_DESERT then
            if farm == false then
                farm = true
                farmDesert()
            end

            local gui = LP.PlayerGui:FindFirstChild("GameGui")
            if gui and gui:FindFirstChild("Exit") and gui.Exit.Visible then
                teleport(PLACE_MAIN)
            end

        elseif placeId == PLACE_MAIN then
            touchFinish()
            task.wait(3)
            teleport(PLACE_DESERT)

            task.delay(120, function()
                if game.PlaceId == PLACE_MAIN then
                    teleport(PLACE_DESERT)
                end
            end)
        end
    end
end)
