local link = "https://raw.githubusercontent.com/N0ne-ExIStenc3/boblus-scriptz/refs/heads/main/ADXmas"

if queue_on_teleport then
	queue_on_teleport(('loadstring(game:HttpGet("%s"))()'):format(link))
end

local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Values = ReplicatedStorage:WaitForChild("Values")
local Players = game:GetService("Players")

local Suspects = require(ReplicatedStorage.Modules.Data.Stages.SuspectsChristmas)
local Traits = require(ReplicatedStorage.Modules.Data.Traits).traits

Values.GuiltySuspect.Value = ""

local function addTrait(list, trait)
	if not table.find(list, trait) then
		table.insert(list, trait)
	end
end

local function DetermineTraits()
	local results = {}
	local workshop = workspace.Map:FindFirstChild("Santa's Workshop")

	if workshop then
		if workshop:FindFirstChild("Wrecked") then
			addTrait(results, Traits.DESTRUCTIVE)
		end
		if workshop:FindFirstChild("HiddenEvidence") then
			local model = workshop.HiddenEvidence:FindFirstChild("Model")
			if model and model.WorldPivot then
				local pos = model.WorldPivot.Position
				if pos.X == 918.271545 and pos.Y == 81.6603241 and pos.Z == 103.707344 then
					addTrait(results, Traits.SNEAKY)
				end
			end
		end
		if workshop:FindFirstChild("ConveyorGiftItem") then
			if workshop.ConveyorGiftItem.Value == "Coal" then
				addTrait(results, Traits.NAUGHTY)
			else
				addTrait(results, Traits.NICE)
			end
		end
	end

	local active = workspace:FindFirstChild("ActiveEvidence")
	if active then
		if active:FindFirstChild("Shoe") and active.Shoe:FindFirstChild("Inside") then
			addTrait(results, Traits.SHOE)
		end
		if active:FindFirstChild("ClosedGifts") then
			addTrait(results, Traits.PEEKER)
		end
		if active:FindFirstChild("FakeLines") then
			addTrait(results, Traits.TARGETTEDATTACK)
		end
	end

	while #results < 3 do addTrait(results, Traits.CREEPY) end
	while #results > 3 do table.remove(results, 4) end

	return results
end

local function FindSuspect(finalTraits)
	for name, data in pairs(Suspects) do
		local m = 0
		for _, t in ipairs(finalTraits) do
			if table.find(data.Traits, t) then
				m = m + 1
			end
		end
		if m == 3 then return name end
	end
	return nil
end

local function ProcessEvidence()
	local traits = DetermineTraits()
	local guilty = FindSuspect(traits)
	if guilty then Values.GuiltySuspect.Value = guilty end
end

local function waitForValidSuspect()
	local v = Values:WaitForChild("GuiltySuspect")
	repeat task.wait() until v.Value ~= ""
	return v.Value
end

local function doAction()
	local Events = ReplicatedStorage:WaitForChild("Events")
	ProcessEvidence()
	task.wait(2)
	local suspectValue = waitForValidSuspect()
	Events.AccuseSuspect:FireServer(suspectValue)
	task.wait(10)
	Events.CreateParty:FireServer(1, "Santa's Workshop", "Friends")
	Events.RetryMap:FireServer()
end

local function clickMenuOnce()
	local player = Players.LocalPlayer
	local vim = game:GetService("VirtualInputManager")
	local camera = workspace.CurrentCamera
	local viewport = camera.ViewportSize
	local x, y = viewport.X * 0.5, viewport.Y * 0.84
	vim:SendMouseButtonEvent(x, y, 0, true, game, 0)
	task.wait()
	vim:SendMouseButtonEvent(x, y, 0, false, game, 0)
end

task.spawn(function()
	repeat task.wait() until game:IsLoaded()
	task.wait(2)

	local player = Players.LocalPlayer
	local menuGui = player.PlayerGui:WaitForChild("MenuGui")

	clickMenuOnce()
	task.wait(2)
	doAction()
end)
